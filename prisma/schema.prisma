generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
}

model User {
  id                  String               @id @default(cuid())
  name                String?
  email               String               @unique
  apiKey              String?              @unique
  phone               String?
  emailVerified       DateTime?
  image               String?
  password            String?
  theme               String?              @default("system")
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  achievements        Achievement[]        @relation("UserAchievements")
  alertConfigurations AlertConfiguration[]
  authenticators      Authenticator[]      @relation("UserAuthenticators")
  bills               Bill[]
  billMemberShares    BillMemberShare[]
  billPayments        BillPayment[]
  categories          Category[]
  challenges          Challenge[]          @relation("UserChallenges")
  creditBills         CreditBill[]
  creditCards         CreditCard[]
  creditExpenses      CreditExpense[]
  creditIncomes       CreditIncome[]
  expenses            Expense[]
  goals               Goal[]
  groups              Group[]
  incomes             Income[]
  integrations        Integration[]        @relation("UserIntegrations")
  members             Member[]
  notifications       Notification[]
  scenarios           Scenario[]           @relation("UserScenarios")
  tags                Tag[]
  stats               UserStats?           @relation("UserStats")
  wallets             Wallet[]
  webhooks            Webhook[]            @relation("UserWebhooks")
}

model Category {
  id             String          @id @default(cuid())
  name           String
  color          String          @default("#3B82F6")
  icon           String?
  type           CategoryType
  userId         String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditExpenses CreditExpense[]
  creditIncomes  CreditIncome[]
  expenses       Expense[]
  goals          Goal[]
  incomes        Income[]

  @@unique([userId, name, type])
}

model Expense {
  id          String      @id @default(cuid())
  description String
  amount      Decimal     @db.Decimal(10, 2)
  date        DateTime
  type        ExpenseType
  paymentType PaymentType @default(DEBIT)
  isRecurring Boolean     @default(false)
  startDate   DateTime?
  endDate     DateTime?
  dayOfMonth  Int?
  transferId  String?
  categoryId  String?
  userId      String
  walletId    String
  tags        String[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  category    Category?   @relation(fields: [categoryId], references: [id])
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet      Wallet      @relation(fields: [walletId], references: [id])
  billPayments BillPayment[]
}

model Income {
  id          String      @id @default(cuid())
  description String
  amount      Decimal     @db.Decimal(10, 2)
  date        DateTime
  type        IncomeType
  paymentType PaymentType @default(DEBIT)
  isRecurring Boolean     @default(false)
  startDate   DateTime?
  endDate     DateTime?
  dayOfMonth  Int?
  transferId  String?
  categoryId  String?
  userId      String
  walletId    String
  tags        String[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  category    Category?   @relation(fields: [categoryId], references: [id])
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet      Wallet      @relation(fields: [walletId], references: [id])
}

model Wallet {
  id           String        @id @default(cuid())
  name         String
  type         String
  userId       String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  billPayments BillPayment[] @relation("BillPayments")
  creditCards  CreditCard[]  @relation("CreditCardBank")
  expenses     Expense[]
  incomes      Income[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
}

model CreditCard {
  id              String          @id @default(cuid())
  name            String
  limit           Decimal         @db.Decimal(10, 2)
  availableCredit Decimal?        @db.Decimal(10, 2)
  closingDay      Int
  dueDay          Int
  bankId          String?
  userId          String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  creditBills     CreditBill[]
  bank            Wallet?         @relation("CreditCardBank", fields: [bankId], references: [id])
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditExpenses  CreditExpense[]
  creditIncomes   CreditIncome[]

  @@unique([userId, name])
}

model CreditIncome {
  id            String      @id @default(cuid())
  description   String
  amount        Decimal     @db.Decimal(10, 2)
  date          DateTime
  categoryId    String?
  userId        String
  creditCardId  String
  creditBillId  String?
  tags          String[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  category      Category?   @relation(fields: [categoryId], references: [id])
  creditCard    CreditCard  @relation(fields: [creditCardId], references: [id], onDelete: Cascade)
  creditBill    CreditBill? @relation(fields: [creditBillId], references: [id], onDelete: SetNull)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([creditCardId])
  @@index([creditBillId])
}

model Group {
  id          Int      @id @default(autoincrement())
  name        String
  userId      String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  bills       Bill[]
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  members     Member[]

  @@unique([userId, name])
}

model Member {
  id        Int               @id @default(autoincrement())
  name      String
  phone     String?
  userId    String
  groupId   Int
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  shares    BillMemberShare[]
  group     Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Bill {
  id          Int               @id @default(autoincrement())
  title       String
  description String?
  amount      Float
  dueDate     DateTime
  paid        Boolean           @default(false)
  userId      String
  groupId     Int
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  group       Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  shares      BillMemberShare[]
}

model BillMemberShare {
  id        Int      @id @default(autoincrement())
  billId    Int
  memberId  Int
  userId    String
  amount    Float
  percent   Float?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  bill      Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([billId, memberId])
}

model Goal {
  id            String          @id @default(cuid())
  userId        String
  title         String
  description   String?
  type          GoalType
  kind          GoalKind        @default(ATTAINMENT)
  operator      GoalOperator
  amount        Decimal         @db.Decimal(12, 2)
  categoryId    String?
  tagName       String?
  categoryIds   String[]        @default([])
  tagFilters    String[]        @default([])
  tagAggregates String[]        @default([])
  tagNames      String[]        @default([])
  walletId      String?
  appliesTo     GoalAppliesTo   @default(BOTH)
  startDate     DateTime?
  endDate       DateTime?
  recurrence    GoalRecurrence?
  active        Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  category      Category?       @relation(fields: [categoryId], references: [id])
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Notification {
  id           String               @id @default(cuid())
  userId       String
  type         NotificationType
  title        String
  message      String
  priority     NotificationPriority @default(MEDIUM)
  isRead       Boolean              @default(false)
  isActive     Boolean              @default(true)
  data         Json?
  scheduledFor DateTime?
  triggeredAt  DateTime?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, type])
  @@index([scheduledFor])
}

model AlertConfiguration {
  id               String          @id @default(cuid())
  userId           String
  type             AlertConfigType
  isEnabled        Boolean         @default(true)
  thresholdAmount  Decimal?        @db.Decimal(12, 2)
  thresholdPercent Float?
  categoryIds      String[]        @default([])
  walletIds        String[]        @default([])
  settings         Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId, isEnabled])
}

model CreditExpense {
  id           String            @id @default(cuid())
  description  String
  amount       Decimal           @db.Decimal(10, 2)
  purchaseDate DateTime
  installments Int               @default(1)
  type         CreditExpenseType @default(EXPENSE)
  categoryId   String?
  creditCardId String
  creditBillId String?
  userId       String
  tags         String[]          @default([])
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  category     Category?         @relation(fields: [categoryId], references: [id])
  creditCard   CreditCard        @relation(fields: [creditCardId], references: [id])
  creditBill   CreditBill?       @relation(fields: [creditBillId], references: [id], onDelete: SetNull)
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, purchaseDate])
  @@index([creditCardId])
  @@index([creditBillId])
}

model CreditBill {
  id             String          @id @default(cuid())
  creditCardId   String
  closingDate    DateTime
  dueDate        DateTime
  totalAmount    Decimal         @db.Decimal(10, 2)
  paidAmount     Decimal         @default(0) @db.Decimal(10, 2)
  status         BillStatus      @default(PENDING)
  userId         String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  payments       BillPayment[]
  creditCard     CreditCard      @relation(fields: [creditCardId], references: [id])
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditExpenses CreditExpense[]
  creditIncomes  CreditIncome[]

  @@unique([creditCardId, closingDate])
  @@index([userId, dueDate])
  @@index([status])
}

model BillPayment {
  id          String     @id @default(cuid())
  billId      String
  amount      Decimal    @db.Decimal(10, 2)
  paymentDate DateTime
  walletId    String
  description String?
  expenseId   String?
  userId      String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  bill        CreditBill @relation(fields: [billId], references: [id], onDelete: Cascade)
  expense     Expense?   @relation(fields: [expenseId], references: [id], onDelete: SetNull)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet      Wallet     @relation("BillPayments", fields: [walletId], references: [id])

  @@index([userId, paymentDate])
  @@index([billId])
  @@index([expenseId])
}

model Achievement {
  id          String    @id @default(cuid())
  userId      String
  badgeType   BadgeType
  title       String
  description String
  earnedAt    DateTime  @default(now())
  progress    Int       @default(100)
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation("UserAchievements", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, badgeType])
  @@index([earnedAt])
}

model Challenge {
  id          String              @id @default(cuid())
  userId      String
  type        ChallengeType
  title       String
  description String
  goal        Decimal             @db.Decimal(12, 2)
  current     Decimal             @default(0) @db.Decimal(12, 2)
  startDate   DateTime
  endDate     DateTime
  status      ChallengeStatus     @default(ACTIVE)
  reward      String?
  categoryId  String?
  difficulty  ChallengeDifficulty @default(MEDIUM)
  metadata    Json?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  user        User                @relation("UserChallenges", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([endDate])
}

model UserStats {
  id                       String    @id @default(cuid())
  userId                   String    @unique
  totalAchievements        Int       @default(0)
  totalChallengesCompleted Int       @default(0)
  currentStreak            Int       @default(0)
  longestStreak            Int       @default(0)
  points                   Int       @default(0)
  level                    Int       @default(1)
  lastActivityDate         DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  user                     User      @relation("UserStats", fields: [userId], references: [id], onDelete: Cascade)

  @@index([points])
  @@index([level])
}

model Scenario {
  id                  String   @id @default(cuid())
  userId              String
  name                String
  description         String?
  duration            Int
  initialBalance      Decimal  @db.Decimal(10, 2)
  monthlyIncome       Decimal  @db.Decimal(10, 2)
  monthlyExpenses     Decimal  @db.Decimal(10, 2)
  monthlySavings      Decimal  @db.Decimal(10, 2)
  incomeChange        Decimal? @db.Decimal(5, 2)
  expensesChange      Decimal? @db.Decimal(5, 2)
  savingsChange       Decimal? @db.Decimal(10, 2)
  oneTimeExpense      Decimal? @db.Decimal(10, 2)
  oneTimeExpenseMonth Int?
  oneTimeIncome       Decimal? @db.Decimal(10, 2)
  oneTimeIncomeMonth  Int?
  inflation           Decimal? @db.Decimal(5, 2)
  investmentReturn    Decimal? @db.Decimal(5, 2)
  color               String   @default("#3B82F6")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation("UserScenarios", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Webhook {
  id            String    @id @default(cuid())
  userId        String
  name          String
  url           String
  secret        String
  isActive      Boolean   @default(true)
  events        String[]
  filters       Json?
  lastTriggered DateTime?
  successCount  Int       @default(0)
  failureCount  Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation("UserWebhooks", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model Integration {
  id                 String          @id @default(cuid())
  userId             String
  platform           IntegrationType
  isActive           Boolean         @default(true)
  chatId             String?
  token              String?
  phoneNumber        String?
  settings           Json?
  enabledCommands    String[]        @default(["balance", "expenses", "summary"])
  notifyTransactions Boolean         @default(true)
  notifyGoals        Boolean         @default(true)
  notifyAlerts       Boolean         @default(true)
  lastUsed           DateTime?
  usageCount         Int             @default(0)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  user               User            @relation("UserIntegrations", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform, chatId])
  @@index([userId])
  @@index([platform, isActive])
}

model Authenticator {
  id                  String    @id @default(cuid())
  userId              String
  credentialID        String    @unique
  credentialPublicKey Bytes
  counter             BigInt    @default(0)
  deviceName          String?
  deviceType          String?
  transports          String[]  @default([])
  aaguid              String?
  lastUsed            DateTime?
  usageCount          Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  user                User      @relation("UserAuthenticators", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([credentialID])
}

enum CategoryType {
  EXPENSE
  INCOME
  BOTH
}

enum ExpenseType {
  RECURRING
  PUNCTUAL
}

enum IncomeType {
  RECURRING
  PUNCTUAL
}

enum PaymentType {
  DEBIT
  PIX_TRANSFER
  CASH
  OTHER
}

enum GoalType {
  RECURRING
  TIMED
}

enum GoalOperator {
  AT_LEAST
  AT_MOST
}

enum GoalAppliesTo {
  EXPENSES
  INCOMES
  BOTH
}

enum GoalRecurrence {
  MONTHLY
}

enum GoalKind {
  ATTAINMENT
  LIMIT
}

enum NotificationType {
  BUDGET_EXCEEDED
  UNUSUAL_SPENDING
  LOW_BALANCE
  GOAL_AT_RISK
  DUPLICATE_TRANSACTION
  RECURRING_DUE
  MONTHLY_SUMMARY
  ACHIEVEMENT
  SYSTEM
  CUSTOM
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AlertConfigType {
  BUDGET_EXCEEDED
  UNUSUAL_SPENDING
  LOW_BALANCE
  GOAL_AT_RISK
  DUPLICATE_TRANSACTION
  RECURRING_DUE
  MONTHLY_SUMMARY
}

enum CreditExpenseType {
  EXPENSE
  REFUND
}

enum BillStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
}

enum BadgeType {
  FIRST_SAVINGS
  SAVINGS_STREAK_7
  SAVINGS_STREAK_30
  SAVED_1K
  SAVED_5K
  SAVED_10K
  NO_SPEND_WEEK
  NO_SPEND_MONTH
  BUDGET_KEEPER
  BILL_MASTER
  FIRST_GOAL
  GOAL_ACHIEVED
  GOAL_STREAK_3
  EMERGENCY_FUND_50
  EMERGENCY_FUND_100
  EARLY_BIRD
  CONSISTENT_USER
  POWER_USER
  CATEGORY_MASTER
  DEBT_FREE
  INVESTMENT_STARTER
  YEAR_REVIEW
}

enum ChallengeType {
  SAVINGS
  NO_SPEND
  BUDGET_LIMIT
  INCOME_INCREASE
  DEBT_REDUCTION
  CATEGORY_CONTROL
  CUSTOM
}

enum ChallengeStatus {
  ACTIVE
  COMPLETED
  FAILED
  ABANDONED
}

enum ChallengeDifficulty {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum IntegrationType {
  TELEGRAM
  WHATSAPP
  SLACK
  DISCORD
}
